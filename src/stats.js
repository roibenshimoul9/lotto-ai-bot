// src/stats.js

export function חשבסטטיסטיקה(draws, opts = {}) {

  const {
    מקסמספר = 37,
    חלוןאחרון = 200,
    מספרזוגות = 12
  } = opts;

  const N = draws.length;
  if (!N) throw new Error("אין נתונים");

  const חלון = Math.min(חלוןאחרון, N);
  const אחרונים = draws.slice(0, חלון);

  const תדירותכללית = Array(מקסמספר + 1).fill(0);
  const תדירותאחרונים = Array(מקסמספר + 1).fill(0);
  const הופעהאחרונה = Array(מקסמספר + 1).fill(null);
  const זוגות = new Map();

  for (let i = 0; i < N; i++) {
    const הגרלה = draws[i];
    const ראשיים = הגרלה.main;

    for (const מספר of ראשיים) {
      תדירותכללית[מספר]++;
      if (הופעהאחרונה[מספר] === null)
        הופעהאחרונה[מספר] = i;
    }

    const מסודר = [...ראשיים].sort((a,b)=>a-b);
    for (let a=0;a<מסודר.length;a++) {
      for (let b=a+1;b<מסודר.length;b++) {
        const מפתח = `${מסודר[a]}-${מסודר[b]}`;
        זוגות.set(מפתח, (זוגות.get(מפתח)||0)+1);
      }
    }
  }

  for (let i=0;i<חלון;i++) {
    for (const מספר of אחרונים[i].main) {
      תדירותאחרונים[מספר]++;
    }
  }

  const הסתברות = 6 / מקסמספר;
  const צפוימספר = N * הסתברות;
  const שונות = N * הסתברות * (1-הסתברות);
  const סטייתתקן = Math.sqrt(שונות);

  const רשימה = [];

  for (let מספר=1; מספר<=מקסמספר; מספר++) {
    const z = סטייתתקן>0 ? (תדירותכללית[מספר]-צפוימספר)/סטייתתקן : 0;
    רשימה.push({
      מספר,
      תדירות: תדירותכללית[מספר],
      z,
      איחור: הופעהאחרונה[מספר] ?? Infinity
    });
  }

  const חמים = [...רשימה].sort((a,b)=>b.תדירות-a.תדירות).slice(0,10);
  const קרים = [...רשימה].sort((a,b)=>a.תדירות-b.תדירות).slice(0,10);
  const מאחרים = [...רשימה].sort((a,b)=>b.איחור-a.איחור).slice(0,10);

  const זוגותחזקים = [...זוגות.entries()]
    .map(([מפתח,כמות])=>{
      const [a,b]=מפתח.split("-").map(Number);
      return {a,b,כמות};
    })
    .sort((x,y)=>y.כמות-x.כמות)
    .slice(0,מספרזוגות);

  let כי2 = 0;
  for (let מספר=1;מספר<=מקסמספר;מספר++) {
    כי2 += ((תדירותכללית[מספר]-צפוימספר)**2)/(צפוימספר||1);
  }

  return {
    N,
    חלון,
    צפוימספר,
    סטייתתקן,
    כי2,
    חמים,
    קרים,
    מאחרים,
    זוגותחזקים
  };
}

export function פורמטלהודעה(נתונים) {

  const רשום = arr =>
    arr.map(x=>`${x.מספר ?? x.a+"-"+x.b} (${x.תדירות ?? x.כמות})`).join(", ");

  return `
📊 ניתוח סטטיסטי (מתוך ${נתונים.N} הגרלות)

🔥 חמים:
${רשום(נתונים.חמים)}

🧊 קרים:
${רשום(נתונים.קרים)}

⏳ מאחרים:
${נתונים.מאחרים.map(x=>`${x.מספר} (${x.איחור} הגרלות)`).join(", ")}

👥 זוגות נפוצים:
${רשום(נתונים.זוגותחזקים)}

📈 צפוי לכל מספר: ${נתונים.צפוימספר.toFixed(2)}
📊 סטיית תקן: ${נתונים.סטייתתקן.toFixed(2)}
📐 Chi-Square: ${נתונים.כי2.toFixed(2)}

⚠️ לוטו הוא משחק אקראי – זה ניתוח נתונים, לא ניבוי זכייה.
`;
}
